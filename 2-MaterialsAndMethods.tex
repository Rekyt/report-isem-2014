\label{sec:M&M}
\section*{Materials and Methods}

\subsection*{Population model}

We used a previously developed model with stage-structure (Cite XXXXX Sandell et al.). We have two classes in our simulated tree population: immatures (I) and matures (M).
Explain the parameters.
The corresponding Lefkovitch matrix is:
\begin{equation}
	\label{eq:popmat}
	A =
	\begin{pmatrix}
	a_{II} & a_{IM} \\
	a_{MI} & a_{MM}
	\end{pmatrix}
	=
	\begin{pmatrix}
	s_{0} m f_{1} + s_{I} (1 - m) & s_{0} f_{2} \\
	s_{M} m & s_{M}
	\end{pmatrix}
\end{equation}

From the original model (Sandell et al. 2014) we implemented density-dependence, so that population will not continuously increase but reach a plateau (see Fig.~\ref{fig:dd}). We chose to implement density-dependence through seed germination and survival parameter $s_{0}$ using a Beverton-Holt function to avoid chaotic behaviors:
\begin{equation}
	\label{eq:ddfunc}
	s_{0} = \frac{s_{0, max}}{1 + k_{I} N_{I} + k_{M} N_{M}}
\end{equation}

with $k_{I}$ and $k_{M}$ the weights of immature ($N_{I}$) and mature ($N_{M}$) population respectively. $s_{0, max}$ is the maximum achievable $s_{0}$.

\subsection*{Life-history traits}

We considered certain life-history trait $s_{I}, f_{1}, f_{2}$ as gaussian for each individual such as:

\begin{equation}
	\label{eq:indlht}
	s_{I}(z) = s_{I}(\theta_{s})	\exp\left(-\frac{(z - \theta_{s})^2}{2\omega_{s}}\right)
\end{equation}

Averaging over the population it gives:

\begin{equation}
	\label{eq:poplht}
	\overline{s_{I}}(\overline{z_{I}}) = s_{I}(\theta_{s}) \sqrt{\frac{\omega_{s}}{\omega_{s}+P_{I}}}	\exp\left(-\frac{(\overline{z_{I}} - \theta_{s})^2}{2(\omega_{s}+P_{I})}\right)
\end{equation}

\subsection*{Iterations at each timestep}

Assuming the phenotype has a Gaussian distribution,  the mean genotypic value of matures and immatures at the next timestep is given by (\citealt{barfield_evolution_2011} Eq.5) :

\begin{equation}
	\begin{align}
		\label{eq:genotypic}
		\overline{g_{I}}' &= (c_{I M} \overline{g_{M}} + c_{I I} \overline{g_{I}}) 
			\left(c_{I M} G_{M} \frac{\partial \log \overline{a_{IM}}}{\partial \overline{z_{M}}} + c_{I I} G_{I} \frac{\partial \overline{a_{I I}}}{\partial \overline{z_{I}}} \\
		\overline{g_{M}}' &=	 (c_{M I} \overline{g_{I}} + c_{M M} \overline{g_{M}}) 
			\left(c_{M I} G_{I} \frac{\partial \log \overline{a_{M I}}}{\partial \overline{z_{I}}} + c_{M M} G_{M} \frac{\partial \overline{a_{M M}}}{\partial \overline{z_{M}}}
	\end{align}
\end{equation}

When there is a reproduction event, the phenotype of the newborn is computed as such:
...

\subsection*{Approximation under weak selection}

From \citep{engen_evolution_2011} and Sandell et al. we get the following approximation of the mean phenotype in the population:
\begin{equation}
	z = ...
\end{equation}

\subsection*{Fluctuating environment}

To mimic a fluctuating environment, the optimums are fluctuating in various ways around a mean.

Under fluctuations we get another approximation supposing weak selection \citep{engen_evolution_2011}:
...

\subsection*{Trend in change}
...

\subsection*{Phenofit data}

PHENOFIT is phenology model...

On 6 localities (see map .) we had modelled budburst date and predicted fitnesses $\pm$ 21 days around this date, from these data we predicted the optimums fluctuations:
...
All statistical analysis were made using R, for the plots we used the package ggplot2.

\begin{table}
\begin{center}
	\rowcolors{1}{white}{lightgray}
	\begin{tabular}{l c c}
		\hline \hline
		Parameter & Notation & Value \\
		\hline
		\multicolumn{3}{l}{\textbf{Life Cycle}} \\
		Optimal phenotype for fecundity & $\theta_{f}$ & 100 \\
		Optimal phenotype for immature survival & $\theta_{s}$ & 130 \\
		Fecundity function width & $\omega_{f}$ & 400 \\
		Survival function width & $\omega_{s}$ & 400 \\
		Heritability & $h^2$ & 0.5 \\
		Phenotypic variance of immatures & $P_{I}$ & 40 \\
		Phenotypic variance of matures & $P_{M}$ & 40 \\
		Genotypic variance of immatures & $G_{I} = P_{I} \times h^2$ & 20 \\
		Genotypic variance of matures & $G_{M}$ & 20 \\
		Survival of immature at phenotypic optimum & $\overline{s_{I}}(\overline{z} = \theta_{s})$ & 0.8 \\
		Fecundity of first time reproducers at optimum & $\overline{f_{1}}(\overline{z} = \theta_{f})$ & 100 \\
		Fecundity of experienced reproducers at optimum & $\overline{f_{2}}(\overline{z} = \theta_{f})$ & 200 \\
		Maturation rate of immature & $m$ & 0.02 \\
		Combined survival and germination rate of seed & $s_{0}$ & 0.03 \\
		Survival of mature stage & $s_{M}$ & 0.99 \\
		\multicolumn{3}{l}{\textbf{Density-dependence}} \\
		Maximum $s_{0}$ in density-dependence function & $s_{0, max}$ & 0.12 \\
		Decreasing factor due to immatures & $k_{I}$ & 0.0001 \\
		Decreasing factor due to matures & $k_{M}$ & 0.005 \\
		\multicolumn{3}{l}{\textbf{Fluctuations}} \\
		Sensitivity of optimum for fecundity to fluctuation & $\alpha_{f}$ & 5 \\
		Sensitivity of optimum for survival to fluctuation & $\alpha_{s}$ & 5 \\
		Noise variance for fecundity & $\sigma_{\xi_{f}}^2$ & 3.725 \\
		Noise variance for survival & $\sigma_{\xi_{s}}^2$ & 3.725 \\
		Correlation between noises & $\rho_{N}$ & 0.5 \\
		\hline \hline
	\end{tabular}
	\caption{Standard parameter set}
	\label{tab:params}
\end{center}
\end{table}

%Basic explanation of the models. We modeled a stage-structured population in two stages: immatures and matures. The demography is given by a transition matrix, with...
%
%\subsection*{Under constant environment, no plasticity}
%
%Using \citet{lande_adaptation_2009}, under weak selection we have:
%\begin{equation}
%	\label{eq:dz}
%	\Delta\overline{z} = \frac{d\ln\overline{\lambda}(\overline{z})}{d\overline{z}} = \frac{1}{\overline{\lambda}(\overline{z})} \frac{d\overline{\lambda}(\overline{z})}{d\overline{z}}
%\end{equation}
%
%And we have:
%\begin{align*}
%	\overline{\lambda}(\overline{z}) &= \sum_{i,j}{v_{i} u_{j} \overline{a_{ij}}} \\
%	&= v_{I} u_{I} \overline{a_{II}} + v_{I} u_{M} \overline{a_{IM}} + v_{M} u_{I} \overline{a_{MI}} + v_{M} u_{M} \overline{a_{MM}}
%\end{align*}
%
%With $\overline{a_{ij}}$ the expected values of the coefficent of the transition matrix. Thus,
%\begin{align}
%	\overline{\lambda}(\overline{z}) &= v_{I} u_{I} \left[ \overline{f_{1}}(\overline{z}) m s_{0} + (1-m) \overline{s_{I}}(\overline{z}) \right] + v_{I} u_{M} s_{0} \overline{f_{2}}(\overline{z}) \nonumber \\
%	&\quad + v_{M} u_{I} m s_{M} + v_{M} u_{M} s_M \\
%	\label{eq:dlambda}
%	\frac{d\overline{\lambda}(\overline{z})}{d\overline{z}} &= v_{I} u_{I} \left[ \frac{d\overline{f_{1}}(\overline{z})}{d\overline{z}} m s_{0} + (1-m) \frac{d\overline{s_{I}}(\overline{z})}{d\overline{z}} \right] + v_{I} u_{M} s_{0} \frac{d\overline{f_{2}}(\overline{z})}{d\overline{z}}
%\end{align}
%
%Because $f_{i}$ and $s_{I}$ are gaussians we can write the population means $\overline{f_{i}}$ and $\overline{s_{I}}$ easily.
%
%\begin{subequations}
%	\begin{align}
%	\label{eq:meanf}
%		\overline{f_{1}}(\overline{z}) &= f_{1}(\theta_{f}) \sqrt{\frac{\omega_{f}}{\omega_{f} + P_{I}}} \exp\left(-\frac{(\overline{z}-\theta_{f})^2}{2(\omega_{f}+P_{I})}\right) \\
%		\overline{f_{2}}(\overline{z}) &= f_{2}(\theta_{f}) \sqrt{\frac{\omega_{f}}{\omega_{f} + P_{M}}} \exp\left(-\frac{(\overline{z}-\theta_{f})^2}{2(\omega_{f}+P_{M})}\right) \\
%		\overline{s_{I}}(\overline{z}) &= s_{I}(\theta_{s}) \sqrt{\frac{\omega_{s}}{\omega_{s} + P_{I}}} \exp\left(-\frac{(\overline{z}-\theta_{s})^2}{2(\omega_{s}+P_{I})}\right)
%	\end{align}
%\end{subequations}
%
%Thus we can derive these expression with respect to $\overline{z}$:
%
%\begin{align}
%	\label{eq:dfdz}
%	\frac{\partial \overline{f_{1}}(\overline{z}) }{ \partial \overline{z} } &= f_{1}(\theta_{f}) \sqrt{\frac{\omega_{f}}{\omega_{f} + P_{I}}} \frac{\partial \exp \left(-\frac{(\overline{z}-\theta_{f})^2}{2(\omega_{f}+P_{I})}\right)}{\partial\overline{z}} \nonumber \\
%	&= f_{1}(\theta_{f}) \sqrt{ \frac{\omega_{f}}{ \omega_{f} + P_{I}}}\exp\left(-\frac{(\overline{z}-\theta_{f})^2}{2(\omega_{f}+P_{I})}\right) \frac{\theta_{f} - \overline{z}}{\omega_{f} + P_{I}} \nonumber \\
%	&= \overline{f_{1}}(\overline{z}) \frac{\theta_{f} - \overline{z}}{\omega_{f} + P_{I}}
%\end{align}
%
%We obtain similar formulas for $\overline{f_{2}}$ and $\overline{s_{I}}$. Plugging \eqref{eq:dfdz} into \eqref{eq:dlambda} we have:
%
%\begin{equation}
%	\label{eq:finaldlambda}
%	\frac{d\overline{\lambda}(\overline{z})}{d\overline{z}} = v_{I} u_{I} \left[ \frac{\theta_{f} - \overline{z}}{\omega_{f} + P_{I}} m s_{0} + (1-m) \frac{\theta_{s} - \overline{z}}{\omega_{s} + P_{I}} \right] + v_{I} u_{M} s_{0} \frac{\theta_{f} - \overline{z} }{\omega_{f} + P_{M}}
%\end{equation}
%
%Using \eqref{eq:finaldlambda} into \eqref{eq:dz} gives us after rearranging:
%We have for variations of phenotype, under weak selection:
%\begin{equation}
%	\label{eq:cstdeltaz}
%	\Delta\overline{z} = 
%		(\theta_{f} - \overline{z})
%		\left[ \frac{ v_{I} u_{I} G_{I} s_{0} m \overline{f_{1}} }{ \lambda (P_{I}+\omega_{f}) }
%			+ \frac{ v_{I} u_{M} G_{M} s_{0} \overline{f_{2}} }{ \lambda (P_{M} + \omega_{f}) }
%		\right]
%		+ (\theta_{s} - \overline{z})
%		\left[ \frac{ v_{I} u_{I} G_{I} \overline{s_{I}} (1-m) }{ \lambda (P_{I}+\omega_{s}) }
%		\right]
%\end{equation}
%
%Within the square brackets, we see weighting average of fecundity and survival. Thus, we define them as $\gamma_{f}$ and $\gamma_{s}$ such as:
%
%\begin{subequations}
%	\begin{equation}
%	\label{eq:gammaf}
%	\gamma_{f} = \frac{v_{I} u_{I} s_{0} m \overline{f_{1}} }{\lambda(P_{I}+\omega_{f})} + \frac{ v_{I} u_{M} \frac{G_{M}}{G_{I}} s_{0} \overline{f_{2}}}{\lambda ( P_{M} + \omega_{f} )}
%	\end{equation}
%	and
%	\begin{equation}
%	\label{eq:gammas}
%	\gamma_{s} = \frac{ v_{I} u_{I} \overline{s_{I}} (1-m) }{\lambda(P_{I}+\omega_{s})}
%	\end{equation}
%\end{subequations}
%
%We end up having a simpler expression for $\Delta\overline{z}$ under constant environment:
%
%\begin{align}
%	\Delta\overline{z} &= -G_{I} \left[ \gamma_{f}(\overline{z} - \theta_{f}) + \gamma_{s}(\overline{z} - \theta_{s}) \right] \nonumber \\
%	\Delta\overline{z} &= - G_{I} \gamma(\overline{z} - \theta_{v})
%\end{align}
%
%with
%\begin{align}
%	\label{eq:gamma}
%	\gamma &= \gamma_{f} + \gamma_{s} \\
%	\label{eq:thetav}
%	\theta_{v} &= \frac{\frac{\gamma_{f}}{\gamma_{s}}\theta_{f} + \theta_{s}}{\frac{\gamma_{f}}{\gamma_{s}} + 1}
%\end{align}
%
%\subsection*{Under varying environment, without plasticity}
%From \citet{engen_evolution_2011}, we derived equations for mean variation of phenotype on our model.
%
%We supposed an auto-correlated fluctuating environment $\epsilon_{t}$ influencing optimums $\theta_{i}$ such as:
%\begin{align}
%	\label{eq:epstheta}
%\left\{
%	\begin{aligned}
%		\theta_{i}(t) &= \overline{\theta}_{i} + \alpha_{i}\epsilon_{t}\\
%		\epsilon_{t+1} &= (1-\rho)\overline{\epsilon} + \rho\epsilon_{t} + \xi
%	\end{aligned}
%\right.
%\end{align}
%with $\alpha_{i}$ the dependence factor of the optimum on the environment, $\rho$ the auto-correlation coefficient of the environment, $\overline{\epsilon}$ the expected environment and $\xi$ a gaussian noise vector with variance $\sigma^{2}_{\xi}$ and mean $0$. We chose $\overline{\epsilon}=0$ to simplify the calculations so that $\epsilon_{t+1} = \rho\epsilon_{t} + \xi$, we can see that:
%
%\begin{align}
%	\theta_{i}(t+1) &= \overline{\theta}_{i} + \alpha_{i}\epsilon_{t+1} \nonumber \\
%	&= \overline{\theta}_{i} + \alpha_{i}(\rho\epsilon_{t} + \xi) \nonumber \\
%	&= \overline{\theta}_{i} + \alpha_{i}\rho(\frac{\theta_{i}(t)-\overline{\theta}_{i}}{\alpha_{i}}) + \alpha_{i}\xi \nonumber \\
%	\label{eq:thetait}
%	\theta_{i}(t+1) &= \overline{\theta}_{i}(1-\rho) + \rho\theta_{i}(t) + \alpha_{i}\xi
%\end{align}
%
%The auto-correlation in the environment $\epsilon_{t}$ causes $\theta_{i}$ to be auto-correlated with the same correlation coefficient $\rho$.
%
%Using the same approach as in a constant environment, under weak selection, we end up having a similar equation than \eqref{eq:cstdeltaz} but with optimum depending on environment:
%
%\begin{equation}
%	\label{eq:deltazt}
%	\Delta\overline{z}_{t} = 
%		(\theta_{f}(t) - \overline{z_{t}})
%		\left[ \frac{ v_{I} u_{I} G_{I} s_{0} m \overline{f_{1}} }{ \lambda_{t} (P_{I}+\omega_{f}) }
%			+ \frac{ v_{I} u_{M} G_{M} s_{0} \overline{f_{2}} }{ \lambda_{t} (P_{M} + \omega_{f}) }
%		\right]
%		+ (\theta_{s}(t) - \overline{z_{t}})
%		\left[ \frac{ v_{I} u_{I} G_{I} \overline{s_{I}} (1-m) }{ \lambda_{t} (P_{I}+\omega_{s}) }
%		\right]
%\end{equation}
%
%Plugging \eqref{eq:epstheta} in \eqref{eq:deltazt} we obtain
%
%\begin{subequations}
%	\begin{align}
%		\Delta\overline{z}_{t} &= 
%			(\overline{\theta}_{f} + \alpha_{f}\epsilon_{t} - \overline{z_{t}})
%			\left[ \frac{ v_{I} u_{I} G_{I} s_{0} m \overline{f_{1}} }{ \lambda_{t} (P_{I}+\omega_{f}) }
%				+ \frac{ v_{I} u_{M} G_{M} s_{0} \overline{f_{2}} }{ \lambda_{t} (P_{M} + \omega_{f}) }
%			\right]
%			+ (\overline{\theta}_{s} + \alpha_{s}\epsilon_{t} - \overline{z_{t}})
%			\left[ \frac{ v_{I} u_{I} G_{I} \overline{s_{I}} (1-m) }{ \lambda_{t} (P_{I}+\omega_{s}) }
%			\right] \nonumber \\
%	\end{align}
%	Defining the same $\gamma_{f}$, $\gamma_{s}$ and $\theta_{v}$ as in \eqref{eq:gammaf}, \eqref{eq:gammas} and \eqref{eq:thetav}, respectively:
%	\begin{align}
%			\Delta\overline{z}_{t} &= G_{I} \left[(\overline{\theta}_{f} + \alpha_{f}\epsilon_{t} - \overline{z_{t}})
%			\gamma_{f}
%			+ (\overline{\theta}_{s} + \alpha_{s}\epsilon_{t} - \overline{z_{t}})
%			\gamma_{s} \right] \nonumber \\
%			&= - G_{I} \left[ \gamma_{f}(\overline{z_{t}} - \theta_{f}) + \gamma_{s}(\overline{z_{t}} - \theta_{s}) \right] -G_{I} \epsilon_{t} \left( \gamma_{f}\alpha_{f} + \gamma_{s}\alpha_{s} \right) \nonumber \\
%			\label{eq:deltaztdeltaz}
%			\Delta\overline{z}_{t} &= \Delta\overline{z} + G_{I} \epsilon_{t} \left( \gamma_{f}\alpha_{f} + \gamma_{s}\alpha_{s} \right) \\
%			&= -G_{I}\gamma(\overline{z_{t}} - \theta_{v})  + G_{I} \epsilon_{t} \left( \gamma_{f}\alpha_{f} + \gamma_{s}\alpha_{s} \right) \nonumber \\
%			&= -G_{I}\gamma \left(\overline{z_{t}} - \theta_{v} - \epsilon_{t} \frac{\gamma_{f}\alpha_{f}+\gamma_{s}\alpha_{s}}{\gamma} \right) \nonumber \\
%			\label{eq:totaldeltazt}
%			\Delta\overline{z}_{t} &= -G_{I}\gamma (\overline{z_{t}} - \theta_{v} - \alpha_{v}\epsilon_{t})
%	\end{align}
%\end{subequations}
%With $\alpha_{v}$ a weighted component between $\alpha_{f}$ and $\alpha_{s}$, defined in similar fashion as $\theta_{v}$ in \eqref{eq:thetav}:
%\begin{align}
%	\alpha_{v} &= \frac{\gamma_{f}\alpha_{f}+\gamma_{s}\alpha_{s}}{\gamma} \nonumber \\
%	&= \frac{ \gamma_{f}\alpha_{f}+\gamma_{s}\alpha_{s} }{\gamma_{f}+\gamma_{s}} \nonumber \\
%	\alpha_{v} &=\frac{\frac{\gamma_{f}}{\gamma_{s}}\alpha_{f}+\alpha_{s}}{ \frac{\gamma_{f}}{\gamma_{s}} + 1}
%\end{align}
%
%\subsubsection*{Estimating variance of $\overline{z}_{t}$}
%
%Taking \eqref{eq:totaldeltazt} we can estimate variance of $\overline{z}_{t}$. Using the same process as \citet{engen_evolution_2011}. Indeed, \eqref{eq:totaldeltazt} has the form:
%\begin{equation}
%	\label{eq:defdeltaat}
%	\Delta A_{t}=-D A_{t} + e_{t}
%\end{equation}
% with $A_{t}=\overline{z_{t}} - \theta_{v}$, $D = G_{I} \gamma$ and $e_{t} = D\alpha_{v}\epsilon_{t}$. \eqref{eq:defdeltaat} has a stationary solution:
%
%\begin{subequations}
%	\begin{equation}
%		\label{at+1}
%		A_{t+1} = (1-D)^{t+1} A_{0} + \sum_{r=0}^{t} (1-D)^{r} e_{t-r}
%	\end{equation}
%	
%	If we consider the evolution of $A_{t}$ over a long time, \eqref{at+1} becomes, because $(1-D) < 1$:
%	
%	\begin{align}
%		\label{atsum}
%		A_{t} = \sum_{r=0}^{\infty}e_{t-r}(1-D)^{r}
%	\end{align}
%\end{subequations}
%
%We want to estimate how will $\overline{z}_{t}$ move away from the mean because of environmental fluctuations, that is why we compute its variance. From \eqref{at+1}:
%\begin{equation}
%	\begin{aligned}
%	\text{Var}(A_{t}) &= \text{Var} \left[ \sum_{r=0}^{\infty}e_{t-r}(1-D)^{r} \right] \\
%	&= \sum_{r=0}^{\infty} \text{Var} \left[ e_{t-r}(1-D)^{r} \right] \\
%	&=  \sum_{r=0}^{\infty} \text{Var} \left[ \epsilon_{t-r} D \alpha_{v} (1-D)^{r} \right] \\
%	&\overset{\text{def}}{=} \sigma_{\epsilon}^{2} D^{2} \alpha_{v}^{2} \sum_{r=0}^{\infty} (1-D)^{2r} \\
%	\text{Var}(A_{t}) &= \sigma_{\epsilon}^{2} D^{2} \alpha_{v}^{2} \frac{1}{1-(1-D)^{2}} \\
%	\text{Var}(\overline{z_{t}}) &\overset{\text{def}}{=} \sigma_{\epsilon}^{2} G_{I}^{2}\gamma^{2} \alpha_{v}^{2} \frac{1}{G_{I}\gamma(2-G_{I}\gamma)} \\
%	\label{eq:varzws}
%	\text{Var}(\overline{z_{t}}) &\overset{\gamma \to 0}{=} \frac{1}{2} G_{I}\gamma\sigma_{\epsilon}^{2}\alpha_{v}^{2}
%	\end{aligned}
%\end{equation}